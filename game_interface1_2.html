<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Duel Game</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .game-container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .player-section { border: 2px solid #333; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .numbers-grid { display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0; }
        .number-card { 
            width: 60px; height: 60px; 
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #007bff; border-radius: 8px;
            cursor: pointer; font-size: 18px; font-weight: bold;
            background: white; transition: all 0.2s;
        }
        .number-card:hover { transform: scale(1.05); }
        .number-card.selected { background-color: #007bff; color: white; }
        .number-card.used { 
            background-color: #e9ecef; 
            color: #6c757d; 
            border-color: #6c757d;
            cursor: not-allowed;
            text-decoration: line-through;
        }
        .controls { margin: 15px 0; text-align: center; }
        button { 
            padding: 12px 24px; margin: 5px; cursor: pointer; 
            background: #28a745; color: white; border: none; border-radius: 5px;
            font-size: 16px; transition: background 0.2s;
        }
        button:hover { background: #218838; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #gameLog { 
            height: 200px; overflow-y: auto; border: 1px solid #ccc; 
            padding: 10px; margin: 10px 0; background-color: #f8f9fa;
            border-radius: 5px; font-family: monospace;
        }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .config-section { background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin: 10px 0; }
        
        /* 已使用数字样式 */
        .used-numbers { margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; }
        .used-numbers h3 { margin-top: 0; color: #6c757d; }
        .used-numbers-grid { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 8px; 
            margin-top: 10px;
        }
        .used-number-column { 
            display: flex; 
            flex-direction: column;
            align-items: center;
        }
        .used-number-column-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #495057;
            font-size: 14px;
        }
        .used-number-item { 
            width: 100%;
            padding: 8px 5px; 
            margin: 2px 0;
            background: #e9ecef; 
            border-radius: 4px; 
            color: #6c757d;
            text-decoration: line-through;
            text-align: center;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .used-number-item.empty {
            background: transparent;
            color: transparent;
        }
        
        /* 对方已使用数字样式 */
        .opponent-used-numbers {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .opponent-used-numbers h3 {
            margin-top: 0;
            color: #6c757d;
        }
        .opponent-used-numbers-grid { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 8px; 
            margin-top: 10px;
        }
        .opponent-used-number-column { 
            display: flex; 
            flex-direction: column;
            align-items: center;
        }
        .opponent-used-number-column-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #495057;
            font-size: 14px;
        }
        .opponent-used-number-item { 
            width: 100%;
            padding: 8px 5px; 
            margin: 2px 0;
            background: #e9ecef; 
            border-radius: 4px; 
            color: #6c757d;
            text-decoration: line-through;
            text-align: center;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .opponent-used-number-item.empty {
            background: transparent;
            color: transparent;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 style="text-align: center; color: #333;"> Text Duel Game</h1>
        
        <div class="config-section">
            <h3>⚙️ 连接设置</h3>
            <label for="serverIP">游戏服务器IP地址:</label>
            <input type="text" id="serverIP" value="10.2.3.31" style="padding: 5px; margin: 0 10px;">
            <button onclick="updateServerIP()">更新连接</button>
            <p><small>提示: 在ROS 2主机上运行 <code>hostname -I</code> 查看IP地址</small></p>
        </div>
        
        <div id="connectionStatus" class="status info">准备连接...</div>
        
        <div class="player-section">
            <h2> Your Numbers</h2>
            <div id="numbersGrid" class="numbers-grid">No numbers yet. Join the game first.</div>
            
            <div class="used-numbers">
                <h3>已使用的数字</h3>
                <div class="used-numbers-grid">
                    <div class="used-number-column">
                        <div class="used-number-column-title">当前使用</div>
                        <div id="currentUsedNumber" class="used-number-item empty"></div>
                    </div>
                    <div class="used-number-column">
                        <div class="used-number-column-title">1</div>
                        <div id="recentUsedNumber1" class="used-number-item empty"></div>
                    </div>
                    <div class="used-number-column">
                        <div class="used-number-column-title">2</div>
                        <div id="recentUsedNumber2" class="used-number-item empty"></div>
                    </div>
                    <div class="used-number-column">
                        <div class="used-number-column-title">3</div>
                        <div id="recentUsedNumber3" class="used-number-item empty"></div>
                    </div>
                    <div class="used-number-column">
                        <div class="used-number-column-title">4</div>
                        <div id="recentUsedNumber4" class="used-number-item empty"></div>
                    </div>
                </div>
            </div>
            
            <div class="opponent-used-numbers">
                <h3>对方当前回合使用的数字</h3>
                <div class="opponent-used-numbers-grid">
                    <div class="opponent-used-number-column">
                        <div class="opponent-used-number-column-title">当前使用</div>
                        <div id="currentOpponentUsedNumber" class="opponent-used-number-item empty"></div>
                    </div>
                    <div class="opponent-used-number-column">
                        <div class="opponent-used-number-column-title">1</div>
                        <div id="recentOpponentUsedNumber1" class="opponent-used-number-item empty"></div>
                    </div>
                    <div class="opponent-used-number-column">
                        <div class="opponent-used-number-column-title">2</div>
                        <div id="recentOpponentUsedNumber2" class="opponent-used-number-item empty"></div>
                    </div>
                    <div class="opponent-used-number-column">
                        <div class="opponent-used-number-column-title">3</div>
                        <div id="recentOpponentUsedNumber3" class="opponent-used-number-item empty"></div>
                    </div>
                    <div class="opponent-used-number-column">
                        <div class="opponent-used-number-column-title">4</div>
                        <div id="recentOpponentUsedNumber4" class="opponent-used-number-item empty"></div>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <button id="joinButton" onclick="joinGame()">Join Game</button>
                <button id="playButton" onclick="playSelectedNumbers()" disabled>Play Selected Numbers</button>
                <button id="endButton" onclick="ReGame()">Re Game</button>
            </div>
        </div>
        
        <div class="player-section">
            <h2> Game State</h2>
            <div id="gameState">Waiting for players to join...</div>
        </div>
        
        <div class="player-section">
            <h2> Game Log</h2>
            <div id="gameLog">Game log will appear here...</div>
        </div>
    </div>

    <script>
        class GameClient {
            constructor() {
                this.ws = null;
                this.playerId = null;
                this.numbers = [];
                this.usedNumbers = []; // 存储自己已使用的所有数字
                this.usedNumbersHistory = []; // 存储自己最近使用的数字历史
                this.currentRoundOpponentNumbers = []; // 存储对方当前回合使用的数字
                this.opponentUsedNumbersHistory = []; // 存储对方最近使用的数字历史
                this.selectedNumbers = [];
                this.connected = false;
                this.serverIP = '10.2.3.31';
                this.isConnected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.round = 0;
                this.currentRound = 0;
                
                // 从URL获取玩家ID
                const urlParams = new URLSearchParams(window.location.search);
                this.playerId = urlParams.get('player') || 'player1';
                
                // 设置IP输入框的默认值
                document.getElementById('serverIP').value = this.getDefaultIP();
                
                this.connect();
            }
            
            getDefaultIP() {
                return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                    ? 'localhost' 
                    : '10.2.3.31';
            }
            
            connect() {
                if (this.ws) {
                    this.ws.close();
                }
                
                this.serverIP = document.getElementById('serverIP').value || this.getDefaultIP();
                const wsUrl = `ws://${this.serverIP}:8002`;
                
                try {
                    this.updateStatus(` 正在连接到 ${this.serverIP}:8002`, 'info');
                    console.log('Connecting to:', wsUrl);
                    
                    this.ws = new WebSocket(wsUrl);
                    
                    this.ws.onopen = () => {
                        console.log('Connected to game server');
                        this.isConnected = true;
                        this.connected = true;
                        this.reconnectAttempts = 0;
                        this.updateStatus('✅ 已连接到游戏服务器', 'success');
                        this.addToLog('Connected to game server at ' + this.serverIP);
                    };

                    this.ws.onclose = (event) => {
                        console.log('WebSocket closed:', event);
                        this.isConnected = false;
                        this.connected = false;
                        
                        if (!event.wasClean) {
                            this.handleReconnect();
                        }
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.updateStatus('❌ 连接错误', 'error');
                    };
                    
                    this.ws.onmessage = (event) => {
                        try {
                            console.log('Raw message received:', event.data);
                            const data = JSON.parse(event.data);
                            this.handleMessage(data);
                        } catch (e) {
                            console.error('Error parsing message:', e);
                            this.addToLog('Error parsing server message: ' + e.message);
                        }
                    };
                } catch (error) {
                    console.error('Connection error:', error);
                    this.updateStatus('❌ 创建连接失败', 'error');
                    this.handleReconnect();
                }
            }
            
            handleMessage(data) {
                console.log('Parsed message:', data);
                
                switch(data.type) {
                    case 'numbers_assigned':
                        this.numbers = data.numbers || [];
                        // if (this.round === 0) {
                        //     this.usedNumbers = [];
                        //     this.usedNumbersHistory = [];
                        //     this.currentRoundOpponentNumbers = [];
                        //     this.opponentUsedNumbersHistory = [];
                        // }
                        this.round += 1;
                        this.renderNumbers();
                        this.updateUsedNumbersDisplay();
                        this.updateOpponentUsedNumbersDisplay();
                        this.updateStatus('✅ 数字分配完成! 游戏准备就绪', 'success');
                        this.addToLog(`You received ${this.numbers.length} numbers: ${this.numbers.join(', ')}`);
                        
                        if (this.round % 2 === 0) {
                            this.currentRound = this.round / 2;
                            this.addToLog(`Round ${this.currentRound}`);
                        }
                        break;
                        
                    case 'game_start':
                        this.addToLog(' 游戏开始! 双方玩家已就位');
                        this.addToLog(`上次出牌: ${data.last_player}`);
                        break;
                        
                    case 'game_state':
                        this.updateGameState(data);
                        break;
                  
                    case 'move_accepted':
                        // 处理自己打出的数字
                        if (data.numbers_played && !data.numbers_played.includes(-1)) {
                            // 添加到历史记录
                            this.usedNumbersHistory.unshift(data.numbers_played);
                            // 只保留最近的4个记录
                            if (this.usedNumbersHistory.length > 4) {
                                this.usedNumbersHistory = this.usedNumbersHistory.slice(0, 4);
                            }
                            
                            this.usedNumbers.push(...data.numbers_played);
                            this.numbers = this.numbers.filter(num => !data.numbers_played.includes(num));
                            this.renderNumbers();
                            this.updateUsedNumbersDisplay();
                            this.addToLog(`✅ ${data.message}`);
                        }
                        this.usedNumbers=[];
                        break;
                        
                    case 'opponent_move':
                        // 处理对方打出的数字 - 只显示当前回合的
                        if (data.numbers_played && !data.numbers_played.includes(-1)) {
                            this.currentRoundOpponentNumbers = data.numbers_played;
                            
                            // 添加到历史记录
                            this.opponentUsedNumbersHistory.unshift(data.numbers_played);
                            // 只保留最近的4个记录
                            if (this.opponentUsedNumbersHistory.length > 4) {
                                this.opponentUsedNumbersHistory = this.opponentUsedNumbersHistory.slice(0, 4);
                            }
                            
                            this.updateOpponentUsedNumbersDisplay();
                            this.addToLog(`对方打出数字: ${data.numbers_played.join(', ')}`);
                        }
                        else if (data.numbers_played && data.numbers_played.includes(-1)) {
                            this.currentRoundOpponentNumbers = ['skip'];
                            this.updateOpponentUsedNumbersDisplay();
                            this.addToLog(`对方跳过`);
                        }
                        break;
                }
            }
            
            joinGame() {
                if (this.connected && this.ws.readyState === WebSocket.OPEN) {
                    const joinMsg = {
                        type: 'player_join',
                        player_id: this.playerId
                    };
                    console.log('Sending join message:', joinMsg);
                    this.sendMessage(joinMsg);
                    this.addToLog(`Joining game as ${this.playerId}...`);
                    document.getElementById('joinButton').disabled = true;
                } else {
                    this.updateStatus('❌ 未连接到服务器', 'error');
                    this.addToLog('Cannot join: WebSocket not connected');
                }
            }

            ReGame() {
                if (this.connected && this.ws.readyState === WebSocket.OPEN) {
                    const joinMsg = {
                        type: 'start_new_round',
                        player_id: this.playerId
                    };
                    console.log('Sending ReGame message:', joinMsg);
                    this.sendMessage(joinMsg);
                    this.addToLog(`Requesting new game round...`);
                } else {
                    this.updateStatus('❌ 未连接到服务器', 'error');
                    this.addToLog('Cannot request new round: WebSocket not connected');
                }
            }
            
            sendMessage(message) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify(message));
                    console.log('Message sent:', message);
                } else {
                    console.error('Cannot send message: WebSocket not open');
                    this.addToLog('Error: Cannot send message - connection closed');
                }
            }
            
            toggleNumber(number, index) {
                if (this.usedNumbers.includes(number)) {
                    return;
                }
                
                const uniqueId = `${number}_${index}`;
                const isSelected = this.selectedNumbers.some(selected => selected.uniqueId === uniqueId);
                
                if (isSelected) {
                    this.selectedNumbers = this.selectedNumbers.filter(selected => selected.uniqueId !== uniqueId);
                } else {
                    this.selectedNumbers.push({
                        number: number,
                        uniqueId: uniqueId,
                        index: index
                    });
                }
                
                this.renderNumbers();
                document.getElementById('playButton').disabled = this.selectedNumbers.length === 0;
            }

            renderNumbers() {
                const grid = document.getElementById('numbersGrid');
                grid.innerHTML = '';
                
                if (this.numbers.length === 0 && this.usedNumbers.length === 0) {
                    grid.innerHTML = '<div style="text-align: center; width: 100%; color: #666; padding: 20px;">No numbers available</div>';
                    return;
                }
                
                const sortedNumbersWithIndex = this.numbers
                    .map((number, index) => ({ number, index }))
                    .sort((a, b) => a.number - b.number);
                
                sortedNumbersWithIndex.forEach(({ number, index }) => {
                    const card = document.createElement('div');
                    card.className = 'number-card';
                    
                    const isSelected = this.selectedNumbers.some(
                        selected => selected.uniqueId === `${number}_${index}`
                    );
                    
                    if (isSelected) {
                        card.classList.add('selected');
                    }
                    
                    card.textContent = number;
                    card.onclick = () => this.toggleNumber(number, index);
                    grid.appendChild(card);
                });
            }
            
            updateUsedNumbersDisplay() {
                // 当前使用的数字
                const currentUsedElement = document.getElementById('currentUsedNumber');
                if (this.usedNumbers.length > 0) {
                    currentUsedElement.textContent = this.usedNumbers[this.usedNumbers.length - 1];
                    currentUsedElement.classList.remove('empty');
                } else {
                    currentUsedElement.textContent = '';
                    currentUsedElement.classList.add('empty');
                }
                
                // 最近使用的数字历史
                const recentElements = [
                    document.getElementById('recentUsedNumber1'),
                    document.getElementById('recentUsedNumber2'),
                    document.getElementById('recentUsedNumber3'),
                    document.getElementById('recentUsedNumber4')
                ];
                
                for (let i = 0; i < 4; i++) {
                    if (i < this.usedNumbersHistory.length) {
                        recentElements[i].textContent = this.usedNumbersHistory[i].join(', ');
                        recentElements[i].classList.remove('empty');
                    } else {
                        recentElements[i].textContent = '';
                        recentElements[i].classList.add('empty');
                    }
                }
            }
            
            updateOpponentUsedNumbersDisplay() {
                // 当前使用的数字
                const currentOpponentUsedElement = document.getElementById('currentOpponentUsedNumber');

                // // 强制触发重绘
                // if (currentOpponentUsedElement) {
                //     currentOpponentUsedElement.style.display = 'none';
                //     currentOpponentUsedElement.offsetHeight; // 触发重排
                //     currentOpponentUsedElement.style.display = '';
                // }
                // this.addToLog(`You received11111111111111 ${this.currentRoundOpponentNumbers} `);
                // this.addToLog(' ${this.currentRoundOpponentNumbers} : Cannot send message - connection closed');
                if (this.currentRoundOpponentNumbers.length > 0) {
                    currentOpponentUsedElement.textContent = this.currentRoundOpponentNumbers.join(', ');
                    currentOpponentUsedElement.classList.remove('empty');
                } else {
                    currentOpponentUsedElement.textContent = '';
                    currentOpponentUsedElement.classList.add('empty');
                }
                
                // 最近使用的数字历史
                const recentOpponentElements = [
                    document.getElementById('recentOpponentUsedNumber1'),
                    document.getElementById('recentOpponentUsedNumber2'),
                    document.getElementById('recentOpponentUsedNumber3'),
                    document.getElementById('recentOpponentUsedNumber4')
                ];
                
                for (let i = 0; i < 4; i++) {
                    if (i < this.opponentUsedNumbersHistory.length) {
                        recentOpponentElements[i].textContent = this.opponentUsedNumbersHistory[i].join(', ');
                        recentOpponentElements[i].classList.remove('empty');
                    } else {
                        recentOpponentElements[i].textContent = '';
                        recentOpponentElements[i].classList.add('empty');
                    }
                }
            }
            
            playNumbers(numbers) {
                if (this.connected && numbers.length > 0) {
                    const numberValues = numbers.map(item => item.number);
                    
                    const playMsg = {
                        type: 'player_action',
                        player_id: this.playerId,
                        numbers: numberValues
                    };
                    console.log('Sending play message:', playMsg);
                    this.sendMessage(playMsg);
                    this.addToLog(`Playing numbers: ${numberValues.join(', ')}`);
                    
                    this.selectedNumbers = [];
                    document.getElementById('playButton').disabled = true;
                }
            }
            
            updateGameState(data) {
                const stateDiv = document.getElementById('gameState');
                let html = `
                    <p><strong>Player 1:</strong> ${data.player1?.numbers_remaining || 0} numbers remaining</p>
                    <p><strong>Player 2:</strong> ${data.player2?.numbers_remaining || 0} numbers remaining</p>
                `;
                
                if (data.played_numbers && data.played_numbers.length > 0) {
                    html += `<p><strong>Played numbers:</strong> ${data.played_numbers.join(', ')}</p>`;
                }
                
                stateDiv.innerHTML = html;
            }
            
            updateStatus(message, type) {
                const statusDiv = document.getElementById('connectionStatus');
                statusDiv.textContent = message;
                statusDiv.className = `status ${type}`;
            }
            
            addToLog(message) {
                const logDiv = document.getElementById('gameLog');
                const timestamp = new Date().toLocaleTimeString();
                logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
                logDiv.scrollTop = logDiv.scrollHeight;
            }

            handleReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    const delay = Math.min(1000 * this.reconnectAttempts, 10000);
                    
                    console.log(`Reconnecting in ${delay}ms... (attempt ${this.reconnectAttempts})`);
                    this.updateStatus(` 重新连接中... (尝试 ${this.reconnectAttempts}/${this.maxReconnectAttempts})`, 'info');
                    
                    setTimeout(() => {
                        this.connect();
                    }, delay);
                } else {
                    console.error('Max reconnection attempts reached');
                    this.updateStatus('❌ 连接失败，请检查服务器状态和IP地址', 'error');
                }
            }
        }
        
        let gameClient;
        
        window.onload = function() {
            gameClient = new GameClient();
        };
        
        function joinGame() {
            if (gameClient) {
                gameClient.joinGame();
            }
        }

        function ReGame() {
            if (gameClient) {
                gameClient.ReGame();
            }
        }
        
        function playSelectedNumbers() {
            if (gameClient) {
                const numbers = gameClient.selectedNumbers;
                gameClient.playNumbers(numbers);
            }
        }

        function updateServerIP() {
            if (gameClient) {
                gameClient.reconnectAttempts = 0;
                gameClient.connect();
            }
        }
    </script>
</body>
</html>